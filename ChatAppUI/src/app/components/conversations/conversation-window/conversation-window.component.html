<div class="conversation-window">
  <!-- Header -->
  <div class="conversation-header">
    <h2 class="conversation-title">{{ conversation().title }}</h2>
    @if (conversation().type === ConversationType.Direct) {
    <div
      class="online-status-header"
      [class.online]="isOnline()"
      [class.offline]="!isOnline()"
    >
      {{ isOnline() ? "Online" : "Offline" }}
    </div>
    }
  </div>

  <!-- Messages Container -->
  <div class="messages-container">
    @if (loading) {
    <div class="loading-state">
      <!-- <p>Loading messages...</p> -->
    </div>
    } @if (error) {
    <div class="error-state">
      <p>{{ error }}</p>
    </div>
    } @if (!loading && !error && messages.length === 0) {
    <div class="empty-state">
      <p>No messages yet. Start the conversation!</p>
    </div>
    }

    <!-- Messages List -->
    @if (!loading && !error && messages.length > 0) {
    <div #messagesList class="messages-list">
      @for (group of groupedMessages; track group.date) {
      <!-- Date Separator -->
      <div class="date-separator">
        <span class="date-label">{{ group.date }}</span>
      </div>

      @for (message of group.messages; track message.id; let i = $index) {
      <div
        class="message-wrapper"
        [class.current-user]="
          message.senderId === this.currentUserId &&
          message.messageType !== MessageType.System
        "
        [class.other-user]="
          message.senderId !== this.currentUserId &&
          message.messageType !== MessageType.System
        "
        [class.system-message]="message.messageType === MessageType.System"
      >
        <!-- Sender Avatar and Info for Other Users -->
        @if (message.senderId !== this.currentUserId && message.messageType !==
        MessageType.System) {
        <div class="sender-info">
          <div class="sender-avatar">
            {{ message.senderFullName | stringInitials }}
          </div>
          <div class="sender-details">
            <div class="sender-name">{{ message.senderName }}</div>
          </div>
        </div>
        }

        <div class="message-bubble">
          <div class="message-content">{{ message.content }}</div>
          <div class="message-meta">
            @if (message.senderId === this.currentUserId && message.messageType
            !== MessageType.System) {
            <span class="sender-name"> You </span>
            } @if (message.messageType !== MessageType.System) {
            <span class="message-time">{{
              message.sentAt | formatMessageTime
            }}</span>
            } @if (message.senderId === this.currentUserId &&
            message.messageType !== MessageType.System) {
            <span class="delivery-status">
              @if (message.deliveryStatus === DeliveryStatus.Sent) {
              <span class="status-tick sent">✓</span>
              } @else if (message.deliveryStatus === DeliveryStatus.Delivered) {
              <span class="status-tick delivered">✓✓</span>
              } @else if (message.deliveryStatus === DeliveryStatus.Read) {
              <span class="status-tick read">✓✓</span>
              }
            </span>
            }
          </div>
        </div>
      </div>
      } }
    </div>
    }
  </div>

  <!-- Message Input -->
  <div class="message-input-container">
    <div class="input-wrapper">
      <input
        type="text"
        placeholder="Type your message..."
        class="message-input"
        [(ngModel)]="messageText"
        (keyup.enter)="sendMessage()"
        #messageInput
      />
      <button class="send-button" type="button" (click)="sendMessage()">
        <svg
          class="send-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22,2 15,22 11,13 2,9"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>
